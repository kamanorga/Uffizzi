name: Deploy to Uffizzi Redash Project

on:
  pull_request:
    types: [opened,reopened,synchronize,closed]

# 在顶层添加权限设置
permissions:
  contents: read
  pull-requests: write
  id-token: write
  issues: write      # 添加 issues 写权限
  statuses: write    # 添加状态写权限

jobs:
  render-compose-file:
    name: Render Docker Compose File
    runs-on: ubuntu-latest
    if: ${{ github.event_name != 'pull_request' || github.event.action != 'closed' }}
    outputs:
      compose-file-cache-key: ${{ env.COMPOSE_FILE_HASH }}
      compose-file-cache-path: docker-compose.rendered.yml
    steps:
      - name: Checkout git repo
        uses: actions/checkout@v4  # 升级到 v4
      - name: Copy Compose File
        run: |
          cp docker-compose.uffizzi.yml docker-compose.rendered.yml
          cat docker-compose.rendered.yml
      - name: Hash Rendered Compose File
        id: hash
        run: echo "COMPOSE_FILE_HASH=$(md5sum docker-compose.rendered.yml | awk '{ print $1 }')" >> $GITHUB_ENV
      - name: Cache Rendered Compose File
        uses: actions/cache@v3
        with:
          path: docker-compose.rendered.yml
          key: ${{ env.COMPOSE_FILE_HASH }}

  deploy-uffizzi-preview:
    name: Deploy to Uffizzi Redash Project
    needs: render-compose-file
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Download Compose File
        uses: actions/cache@v3
        with:
          path: docker-compose.rendered.yml
          key: ${{ needs.render-compose-file.outputs.compose-file-cache-key }}
          
      - name: Deploy to Uffizzi
        uses: UffizziCloud/preview-action@v2  # 使用 v2 版本
        with:
          compose-file: 'docker-compose.rendered.yml'
          server: 'https://app.uffizzi.com'
          # project: 'redash'  # 先注释掉项目名称，让它使用默认项目
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          
  delete-uffizzi-preview:
    if: ${{ github.event_name == 'pull_request' && github.event.action == 'closed' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Delete Preview
        uses: UffizziCloud/preview-action@v2
        with:
          compose-file: 'docker-compose.uffizzi.yml'
          server: 'https://app.uffizzi.com'
          action: 'delete'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
