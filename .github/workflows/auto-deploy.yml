name: Deploy to Uffizzi

on:
  pull_request:
    types: [opened, reopened, synchronize, closed]

permissions:
  contents: read
  pull-requests: write
  id-token: write

jobs:
  render-compose-file:
    name: Render Docker Compose File
    runs-on: ubuntu-latest
    if: ${{ github.event_name != 'pull_request' || github.event.action != 'closed' }}
    outputs:
      compose-file-cache-key: ${{ env.COMPOSE_FILE_HASH }}
    steps:
      - name: Checkout git repo
        uses: actions/checkout@v4
      - name: Copy Compose File
        run: |
          cp docker-compose.uffizzi.yml docker-compose.rendered.yml
          cat docker-compose.rendered.yml
      - name: Hash Rendered Compose File
        id: hash
        run: echo "COMPOSE_FILE_HASH=$(md5sum docker-compose.rendered.yml | awk '{ print $1 }')" >> $GITHUB_ENV
      - name: Upload Compose File
        uses: actions/upload-artifact@v4
        with:
          name: compose-file-${{ github.run_id }}
          path: docker-compose.rendered.yml

  deploy-uffizzi-preview:
    name: Deploy to Uffizzi
    needs: render-compose-file
    if: ${{ github.event_name != 'pull_request' || github.event.action != 'closed' }}
    runs-on: ubuntu-latest
    steps:
      - name: Download Compose File
        uses: actions/download-artifact@v4
        with:
          name: compose-file-${{ github.run_id }}
          
      - name: Display Compose File
        run: cat docker-compose.rendered.yml
        
      - name: Create Uffizzi Preview
        uses: UffizziCloud/preview-action@v2
        id: preview
        with:
          compose-file: 'docker-compose.rendered.yml'
          server: 'https://app.uffizzi.com'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true

      - name: Comment PR with result
        uses: actions/github-script@v7
        if: always()
        with:
          script: |
            const { context } = require('@actions/github');
            const previewStep = '${{ steps.preview.outcome }}';
            
            let body;
            if (previewStep === 'success') {
              body = 'üöÄ **Uffizzi Preview Environment Created Successfully!**\n\n';
              body += 'Your preview environment is being deployed. Please check the [Uffizzi Dashboard](https://app.uffizzi.com/) for the preview URL.\n\n';
              body += `üìä **Project**: redash\n`;
              body += `üîó **Dashboard**: https://app.uffizzi.com/\n\n`;
              body += '*This preview will be automatically deleted when the PR is closed.*';
            } else {
              body = '‚ùå **Uffizzi Preview Environment Deployment Failed**\n\n';
              body += 'Please check the [Actions logs](' + context.payload.repository.html_url + '/actions/runs/' + context.runId + ') for more details.\n\n';
              body += 'Common issues:\n';
              body += '- Image access permissions\n';
              body += '- Invalid Docker Compose configuration\n';
              body += '- Uffizzi service unavailability';
            }
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

  delete-uffizzi-preview:
    name: Delete Uffizzi Preview
    if: ${{ github.event_name == 'pull_request' && github.event.action == 'closed' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Delete Preview
        uses: UffizziCloud/preview-action@v2
        with:
          compose-file: 'docker-compose.uffizzi.yml'
          server: 'https://app.uffizzi.com'
          action: 'delete'
        continue-on-error: true
